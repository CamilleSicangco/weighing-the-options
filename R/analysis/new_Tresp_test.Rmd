---
title: "Updated T-responses test"
author: "Camille K. Sicangco"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
source(here("R/load_packages.R"))
source(here("R/functions/data_processing_functions.R"))
source(here("R/functions/analysis_functions.R"))
source(here("R/functions/plotting_functions.R"))

# Replace plantecophys::Photosyn with custom version 
# Includes the Heskel et al. 2017 R(T) equation and shutdown of V, J beyond Tcrit
environment(Photosyn_custom) <- asNamespace("plantecophys")
environment(Photosyn_custom_oldTresp) <- asNamespace("plantecophys")

# Replace calc_costgain to compute CGnet with netorig
environment(calc_costgain_netorig) <- asNamespace("gsthermal")
assignInNamespace("calc_costgain", calc_costgain_netorig, ns = "gsthermal")

# Replace C_gain with correction
environment(C_gain_corr) <- asNamespace("gsthermal")
assignInNamespace("C_gain", C_gain_corr, ns = "gsthermal")
```

# Updated T-responses of Vcmax and Jmax

In `plantecophys`, $V_{cmax}$ and $J_{max}$ respond to temperature following a peaked Arrhenius model as shown below.

``` {r old_Tresp}

# Create vector of leaf temperatures
Tleaf_seq = seq(20,70, by = 1)

# Plot old V and J temperature responses
Vcmax = TVcmax(Tleaf_seq,EaV=62307,EdVC=2e5,delsC=639)
Jmax = TJmax(Tleaf_seq, EaJ=33115,EdVJ=2e5,delsJ=635)

plot(Tleaf_seq, Vcmax, ylab = "Vcmax/Vcmax,25")
plot(Tleaf_seq, Jmax, ylab = "Jmax/Jmax,25")
```

The T-response described by the peaked Arrhenius equation seems somewhat at odds with theory underpinning measures of $T_{crit}$ and/or $T_{50}$ via fluorescence, which are intended to indicate the temperatures at which PSII function declines. For example, the Drake et al. (2018) study measured heatwave $T_{crit} = 43.4^\circ C$ and $T_{50} = 49.6^\circ C$. While the Arrhenius temperature response above does indicate that at $T_{50}$, $J_{max}$ would as expected be operating at around 50% its capacity at $25^\circ C$, the decline in $J_{max}$ beyond this temperature is more gradual, which seems potentially unrealistic.

Below I modify the $J_{max}$ T-response so that it is multiplied by $1 - TC$, thus further reducing $J_{max}$ as temperatures rise proportionately to the level of thermal damage to PSII.

``` {r new_Tresp}

# Plot new J temperature responses
Jmax_new = TJmax_updated(Tleaf_seq, EaJ=33115,EdVJ=2e5,delsJ=635, 
                          Tcrit = 43.4, T50 = 49.6)

plot(Tleaf_seq, Jmax_new)

```

# Consequences for optimisation models

Now, I test the consequence of this modified T-response of Jmax for predictions of different stomatal optimisation models. Below I've run the Sperry, Sperry + CGnet, Sperry + CGnet + TC, and Medlyn models with this modification, increasing air temperature from 30 to 60$^\circ C$ and holding all other environmental variables constant. 

``` {r Trange}
# Set environmental variables, increasing Tair from 30 to 60 deg and holding other values constant
Tair_sim.df = data.frame(Tair = seq(30,60, by = 1), 
                         PPFD = 1500, VPD = 1.5, Ps = 0.5)

# Generate predictions using old T-responses
assignInNamespace("Photosyn", Photosyn_custom_oldTresp, ns = "plantecophys")
test_old = get_preds_theoretical_sims(Tair_sim.df, constant_kmax = FALSE, kmax_25 = 2.5,
                                      Tcrit = 43.4, T50 = 48.6)

# Generate predictions using new T-responses
assignInNamespace("Photosyn", Photosyn_custom, ns = "plantecophys")
test_new = get_preds_theoretical_sims(Tair_sim.df, constant_kmax = FALSE, kmax_25 = 2.5,
                                      Tcrit = 43.4, T50 = 48.6)

# Plot results
palette = c(Sperry = "#1E88E5", "Sperry + CGnet" = "#e7d87d", "Sperry + CGnet + TC" = "orange", 
              Medlyn = "#D81B60")
gs_plt_oldTresp = test_old %>%
  filter(Model != "Medlyn") %>% 
  ggplot(aes(x = Tleaf, y = gs, color = Model)) +
  geom_point(size = 3, shape = 1) + 
  theme_classic() +
  scale_color_manual(values = palette, 
                     labels = c(#"Medlyn",
                                "Sperry",
                                expression("Sperry + CG"[net]),
                                expression("Sperry + CG"[net]*" + TC")
                     )) +
  ylim(0,0.8)

gs_plt_newTresp = test_new %>%
  filter(Model != "Medlyn") %>% 
  ggplot(aes(x = Tleaf, y = gs, color = Model)) +
  geom_point(size = 3, shape = 1) + 
  theme_classic() +
  scale_color_manual(values = palette, 
                     labels = c(#"Medlyn",
                                "Sperry",
                                expression("Sperry + CG"[net]),
                                expression("Sperry + CG"[net]*" + TC")
                     )) +
  ylim(0,0.8)

ggarrange(gs_plt_oldTresp + ggtitle("old T resp"),
          gs_plt_newTresp + ggtitle("new T resp"), 
          common.legend = TRUE)
```

Predictions generated with the new and old temperature responses diverge when $T_{leaf} > T_{max}$. In this case, $g_{s}$ increases suddenly and is then maintained at a nonzero value. This difference is due to a difference in the shape of the $CG_{net}$ function, as demonstrated below for $T_{leaf} = 55 ^\circ C$:
``` {r high-temp, message=FALSE, warning=FALSE, fig.width=12.25, fig.height=5.5}
# Hydraulics
Weibull = fit_Weibull(P50 = 4.47, P88 = 5.50)
b = Weibull[1,1]
c = Weibull[1,2]
Pcrit = calc_Pcrit(b, c)
P = Ps_to_Pcrit(Ps = 0.5, Pcrit)

assignInNamespace("Photosyn", Photosyn_custom, ns = "plantecophys")
single_test_new = calc_costgain_netorig(P, b, c, kmax_25 = 2.5, 
                                    Tair = 60, PPFD = 1500, VPD = 1.5,
                                    Tcrit = 43.4, T50 = 49.4, constant_kmax = FALSE,
                                    Wind = 8, Wleaf = 0.02, LeafAbs = 0.5,
                                    Vcmax=34,EaV=62307,EdVC=2e5,delsC=639,
                                    Jmax = 60,EaJ=33115,EdVJ=2e5,delsJ=635, Rd0 = 0.92
)

assignInNamespace("Photosyn", Photosyn_custom_oldTresp, ns = "plantecophys")
single_test_old = calc_costgain_netorig(P, b, c, kmax_25 = 2.5, 
                                    Tair = 60, PPFD = 1500, VPD = 1.5,
                                    Tcrit = 43.4, T50 = 49.6, constant_kmax = FALSE,
                                    Wind = 8, Wleaf = 0.02, LeafAbs = 0.5,
                                    Vcmax=34,EaV=62307,EdVC=2e5,delsC=639,
                                    Jmax = 60,EaJ=33115,EdVJ=2e5,delsJ=635, Rd0 = 0.92
)
composite_plot(single_test_old)
composite_plot(single_test_new)
```

- With the old T-response, $CG_{net}$ is a non-monotonic function since $\lim_{g_c\to0} c_i = +\infty$ results in an increase in $A_{gross}$ as $g_c\to0$. 
- Since the new temperature response sets $A_{gross} = 0$ when $T_{leaf} > T_{max}$ and $R_d$ increases as $g_c\to0$, then $A_{n}$ and thus $CG_{net}$ also decrease as $g_c\to0$.

As a result of the above difference, $CG_{net}$ is monotonic with the updated temperature response of $J_{max}$ but not with the peaked Arrhenius response. A monotonically increasing $CG_{net}$ function results in a bell-shaped profit function, and thus $g_s$ is optimised at a nonzero value.

# Result for a lower value of Tmax

We can also experiment with what happens if $J_{max}$ drops to zero at a lower value of $T_{leaf}$ by decreasing $T_{crit}$ and/or $T_{50}$. Here I do so by setting $T_{50} = 44.4$ so that $T_{max} = 45.4$.

``` {r Trange_lowT50, message=FALSE, warning=FALSE}
# Generate predictions using old T-responses
assignInNamespace("Photosyn", Photosyn_custom_oldTresp, ns = "plantecophys")
test_old = get_preds_theoretical_sims(Tair_sim.df, constant_kmax = FALSE, kmax_25 = 2.5,
                                      Tcrit = 43.4, T50 = 44.4)

# Generate predictions using new T-responses
assignInNamespace("Photosyn", Photosyn_custom, ns = "plantecophys")
test_new = get_preds_theoretical_sims(Tair_sim.df, constant_kmax = FALSE, kmax_25 = 2.5,
                                      Tcrit = 43.4, T50 = 44.4)

# Plot results
gs_plt_oldTresp = test_old %>%
  filter(Model != "Medlyn") %>% 
  ggplot(aes(x = Tleaf, y = gs, color = Model)) +
  geom_point(size = 3, shape = 1) + 
  theme_classic() +
  scale_color_manual(values = palette, 
                     labels = c(#"Medlyn",
                                "Sperry",
                                expression("Sperry + CG"[net]),
                                expression("Sperry + CG"[net]*" + TC")
                     )) +
  ylim(0,0.8)

gs_plt_newTresp = test_new %>%
  filter(Model != "Medlyn") %>% 
  ggplot(aes(x = Tleaf, y = gs, color = Model)) +
  geom_point(size = 3, shape = 1) + 
  theme_classic() +
  scale_color_manual(values = palette, 
                     labels = c(#"Medlyn",
                                "Sperry",
                                expression("Sperry + CG"[net]),
                                expression("Sperry + CG"[net]*" + TC")
                     )) #+
  #ylim(0,0.8)

ggarrange(gs_plt_oldTresp + ggtitle("old T resp"),
          gs_plt_newTresp + ggtitle("new T resp"), 
          common.legend = TRUE)
```

In this scenario, neither of the versions of the Sperry model including the $CG_{net}$ function predict stomatal closure at any temperature.