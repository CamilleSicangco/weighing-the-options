---
title: "Photosynthesis T and gs response issues"
author: "Camille K. Sicangco"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
source(here("R/load_packages.R"))
source(here("R/functions/data_processing_functions.R"))
source(here("R/functions/analysis_functions.R"))

# Replace plantecophys::Photosyn with custom version to use the Heskel et al. 2017 R(T) equation
environment(Photosyn_custom) <- asNamespace("plantecophys")
assignInNamespace("Photosyn", Photosyn_custom, ns = "plantecophys")
```

## Importance of accurate photosynthesis equations for modelling stomatal behaviour

### Background: the Sperry model
The stomatal behaviour model that we have developed is based closely on that of Sperry et al. (2017). The Sperry model works by maximizing a plant's instantaneous profit, where profit is defined as the difference between a carbon gain and hydraulic cost function $$Profit = CG - HC$$. 

The $CG$ and $HC$ functions are modelled by first calculating the transpiration supply stream, a function of $\psi_{leaf}$ ranging from the soil water potential, $\psi_{s}$, to the critical water potential at which 95% loss of conductivity occurs, $\psi_{crit}$: 
$$E = \int_{\psi_{s}}^{\psi_{crit}} k_{max}f(\psi_{leaf}) \,d\psi$$
where $f(\psi_{leaf})$ is a hydraulic conductivity function. From the $E$ supply stream, we can calculate $T_{leaf}$, $D_{leaf}$, $g_s$ via the Penman-Monteith equation, and $A$ via `plantecophys::Photosyn`.

```{r supply-stream}
# Set hydraulic parameters
Weibull = fit_Weibull(P50 = 4.07, P88 = 5.50)
b = Weibull[1,1]
c = Weibull[1,2]
Pcrit = calc_Pcrit(b, c)
kmax_25 = 0.5

# Environmental variables
Ps = 0.5
Tair = 48
VPD = 1.5
PPFD = 1500

# Respiration parameters
Rd0 = 0.92
TrefR = 25

# Calculate physiological variables
P = Ps_to_Pcrit(Ps, Pcrit)
E_vec = trans_from_vc(P, kmax_25, Tair, b, c, constant_kmax = FALSE)
E = trans_from_vc(P, kmax_25, Tair, b, c, constant_kmax = FALSE)
Tleaf = calc_Tleaf(Tair = Tair, VPD = VPD, PPFD = PPFD, 
                   E = E, Wind = 8, Wleaf = 0.02, 
                   LeafAbs = 0.5)
D_leaf = plantecophys::VPDairToLeaf(VPD = VPD, Tair = Tair, 
                                    Tleaf = Tleaf)
g_w = calc_gw(E, Tleaf = Tleaf, Tair = Tair, VPD = VPD, PPFD = PPFD,
              Wind = 8, Wleaf = 0.01)
Rd = Rd0 * exp(0.1178 * (Tleaf - TrefR) - 7.017e-4 * (Tleaf^2 - TrefR^2))

plot(x = P, y = E, xlab = expression(Psi[leaf]*" (-MPa)"))

```

The carbon gain function is calculated as $$CG = \frac{A}{A_{max}},$$ where $A_{max}$ is the maximum value of $A$ over the transpiration supply stream. The original Sperry et al. (2017) publication uses $A_{gross}$ here, although later implementations use $A_{net}$ (Venturas et al. 2018, Sabot et al. 2019).

```{r CG, echo=FALSE}
# Insert CG plot 
CG_gross = C_gain(P, b, c, Amax = NULL, kmax_25, Tair, VPD, PPFD, 
                  Wind = 8, Wleaf = 0.01, LeafAbs = 0.5, 
                  Vcmax=34,EaV=51780,EdVC=2e5,delsC=640, 
                  Jmax = 60,EaJ=21640,EdVJ=2e5,delsJ=633,
                  constant_kmax = TRUE, net = FALSE)
plot(P, CG_gross, xlab = expression(Psi[leaf]*" (-MPa)"))
```

## The carbon gain function in our modified model
Our model is designed to represent the hypothesis that plants open their stomata to promote evaporative cooling and avoid thermal damage to leaves. We use $A_{net}$ in our carbon gain function to ensure that the model accounts for the fact that $A_{net}$ declines at high temperatures due to both reduced $A_{gross}$ beyond the optimum temperature for photosynthesis and increased respiration rates at high temperatures. For sufficiently high temperatures, this choice means that $A_{net}$ is negative and the "carbon gain" function effectively represents a "carbon cost". For intermediate temperatures, the $CG$ should be negative up to a sufficiently high value of $E$, beyond which it should be positive. Note that we calculate $A_{max} = max\mid{A}\mid$ instead of simply the maximum value of $A$.

Theoretically, we expect that this curve should have the same shape as the Sperry model (i.e. a concave downward, monotonically increasing response of $CG$ to increasing $E$), to reflect that as stomata open, $c_i$ should still increase and thus $A$ should increase. The main difference is that this curve should essentially be shifted downwards as temperatures rise so that the $CG$ is negative when $A_{net} < 0$.

### Implementation issues for our modified carbon gain function
Thus far, we have been unable to implement the modified $CG$ function described above in a satisfactory way. Below I outline a few attempts that we have made.


#### Solution of Venturas and Sabot
As mentioned earlier, previous implementations of the Sperry model (Sabot et al. 2019, Venturas et al. 2018) used $A_{net}$ rather than $A_{gross}$ to solve for $CG$. In their solution, $A$ calculated via the FvCB model is set equal to the equation based on Fick's Law, $A = g_c(c_a - c_i).$ This method is used to solve for $c_i$ and thus $A$.

However, this implementation does not suit our requirements, as it still forces A > 0: since the solution must satisfy Fick's Law, $g_s, c_i > 0$, and $c_i < c_a$, then the solution requires $A > 0$. Hence this implementation is not suitable if we are trying to model situations in which $A < 0$ at high temperatures.

```{r CG_original, echo=FALSE}
# Manon's method
#CG_Manon = C_gain_alt(P, b, c, Amax = NULL, kmax_25, Tair, VPD, PPFD, 
#                  Wind = 8, Wleaf = 0.01, LeafAbs = 0.5, 
#                  Vcmax=34,EaV=51780,EdVC=2e5,delsC=640, 
#                  Jmax = 60,EaJ=21640,EdVJ=2e5,delsJ=633,
#                  constant_kmax = TRUE)

#plot(P, CG_Manon)
```

#### Alternative method with plantecophys
An alternative method is that instead of first calculating $c_i$, we can input $g_s$ into `plantecophys::Photosyn`, which calculates $A_c, A_j$ via the following quadratic:

$$b_1A^2 + b_2A + b_3 = 0,$$
where 
$$b_1 = g_c^{-1}$$
$$b_2 = \frac{Rd - \gamma}{g_c} - c_a - \beta$$
$$b_3 = \gamma (c_a - \Gamma^*) - R_d (c_a + \beta)$$
and where $\beta = K_m$ or $2\Gamma^*$ and $\gamma = V_{cmax}$ or $V/J$ if solving for $A_c$ or $A_j$, respectively. From $A$, $c_i$ is then calculated via Fick's Law.

This solution has strange behaviour: it cannot achieve the case at moderately high temperatures where $A$ (and thus $CG$) transitions from negative to positive over the $E$ supply stream. At higher temperatures, $A$ and $CG$ have a strange negative response to increasing $E$ (i.e. increasing $g_s$), and $c_i$ has a non-monotonic response that first increases rapidly before decreasing. The $c_i$ also is discontinuous, as for $g_s = 0$, $c_i = c_a$ but $\lim_{g_c\to 0^+} c_i = \infty.$ This results in a jump discontinuity for $A$ and thus $CG$ when $g_s = 0$.
```{r CG_netorig, echo=FALSE}
# Net orig
CG_netOrig = C_gain(P, b, c, Amax = NULL, kmax_25, Tair, VPD, PPFD, 
                  Wind = 8, Wleaf = 0.02, LeafAbs = 0.5, 
                  Vcmax=34,EaV=51780,EdVC=2e5,delsC=640, 
                  Jmax = 60,EaJ=21640,EdVJ=2e5,delsJ=633,
                  constant_kmax = FALSE, net = TRUE, netOrig = TRUE)

# Calculate photosynthesis and associated variables
Photosyn_v = Vectorize(Photosyn_custom)
Photo_out = Photosyn_v(Ca = 420, GS = g_w, Tleaf = Tleaf, VPD = 1.5, PPFD = 1500,
                       Vcmax=34,EaV=62307,EdVC=2e5,delsC=639,
                       Jmax = 60,EaJ=33115,EdVJ=2e5,delsJ=635
                       )
As_pred = unlist(Photo_out[2,])# - Rd
Ac_pred = unlist(Photo_out[5,])
Aj_pred = unlist(Photo_out[6,])
Rd_pred = unlist(Photo_out[8,])
Ci_pred = unlist(Photo_out[1,])

# Plot CG and A 
plot(P, CG_netOrig, xlab = expression(Psi[leaf]*" (-MPa)"), ylab = "CG")
plot(P, As_pred, xlab = expression(Psi[leaf]*" (-MPa)"), ylab = "A")
plot(P, Ci_pred, xlab = expression(Psi[leaf]*" (-MPa)"), ylab = "Ci")
abline(a = 420, b = 0)
```

We can also plot the estimates of $R_d$ and gross $A_j$ and $A_c$, which show that all three decrease with $E$. This observation makes sense for $R_d$ since $T_{leaf}$ decreases with $E$, but does not make sense for $A_j$ and $A_c$, which intuitively should increase with higher $E$ (and thus higher $g_s$).

```{r gs-zero, echo=FALSE}
# Plot Ac, Aj, and Rd
plot(P, Ac_pred, col = "orange", 
     ylab = "Ac, Aj, Rd", xlab = expression(Psi[leaf]*" (-MPa)"),
     ylim = c(min(c(Ac_pred,Aj_pred)), max(c(Ac_pred,Aj_pred)))
     )
points(P, Aj_pred, col = "blue")
points(P, Rd_pred, col = "grey")
legend(5, 2, col = c("blue", "orange", "grey"), legend = c("Aj", "Ac", "Rd"),
       pch = 19)
```

This problem appears to occur at least in part due to the underlying assumptions of Fick's Law, which is used to derive the quadratic by which `Photosyn` calculates $A$. By rearranging Fick's Law to solve for $c_i$, we have that $$c_i = c_a - \frac{A}{g_c}.$$ A few features of this equation are relevant:

- $\lim_{g_c\to\infty} c_i = c_a.$
- Since $\frac{d c_i}{d g_c} = A g_c^{-2}$, $\frac{d^2c_i}{dg_c^2} = -2A g_c^{-3}$, and $g_c$ > 0:
  - If $A > 0$, then $c_i(g_c)$ is increasing and concave down.
  - If $A < 0$, then $c_i(g_c)$ is decreasing and concave up.

These features reflect the behaviour that we observed above. It also suggests that the Fick's Law equation is not suitable for applications when $A < 0$ and $g_s > 0$, as is the case in our modelling of high temperature gas exchange responses.

#### Working solution
Given the unsuitability of the previous implementation methods, we have settled on the following working solution: we use `Photosyn` to calculate $A$ while setting $R_d = 0$, then subtract out Rd.

```{r CG_gross-Rd, echo=FALSE}
# Working solution
CG_WS = C_gain(P, b, c, Amax = NULL, kmax_25, Tair, VPD, PPFD, 
                  Wind = 8, Wleaf = 0.01, LeafAbs = 0.5, 
                  Vcmax=34,EaV=51780,EdVC=2e5,delsC=640, 
                  Jmax = 60,EaJ=21640,EdVJ=2e5,delsJ=633,
                  constant_kmax = TRUE, net = TRUE, netOrig = FALSE)
plot(P, CG_WS, xlab = expression(Psi[leaf]*" (-MPa)"), ylab = "CG working solution")
abline(h = 0)
```

While this solution does give the desired shape of the response curve, it is somewhat problematic as there is an Rd term in the quadratic to solve for $A_c$ and $A_j$. By setting $R_d = 0$ we thus distort the values of $A_c$ and $A_j$ to some extent.

An ideal solution would be one similar to our second solution, but that substitutes the Fick's Law equation for a more generalizable form applicable to high temperatures.
